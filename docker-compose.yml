version: '3.8'

services:
  # Backend API Service
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: advanced-dashboard-api
    env_file:
      - .env
    environment:
      - MAX_UPLOAD_SIZE_MB=${MAX_UPLOAD_SIZE_MB:-100}
      - TEMP_DIR=/tmp
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DATA_MODE=${DATA_MODE:-auto}
      - PROMETHEUS_BASE_URL=${PROMETHEUS_BASE_URL:-http://prometheus:9090}
      - PROMETHEUS_TIMEOUT_SECONDS=${PROMETHEUS_TIMEOUT_SECONDS:-3}
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-60}
    volumes:
      - /tmp/advanced-dashboard:/tmp
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Frontend Build Stage
  frontend-builder:
    build:
      context: ./frontend
      dockerfile: Dockerfile.build
      args:
        - VITE_API_BASE_URL=${VITE_API_BASE_URL:-/api}
        - VITE_PROMETHEUS_URL=${VITE_PROMETHEUS_URL:-http://192.168.1.211:30090}
        - VITE_GRAFANA_URL=${VITE_GRAFANA_URL:-http://192.168.1.211:30382}
        - VITE_CHATBASE_ENABLED=${VITE_CHATBASE_ENABLED:-true}
        - VITE_CHATBASE_ID=${VITE_CHATBASE_ID:-fhMrQLDuXD6phg6uW1EEW}
    volumes:
      - frontend-dist:/app/dist

  # Nginx Reverse Proxy & Static File Server
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: advanced-dashboard-nginx
    ports:
      - "${NGINX_PORT:-8088}:80"
    depends_on:
      frontend-builder:
        condition: service_completed_successfully
      api:
        condition: service_healthy
    volumes:
      - frontend-dist:/usr/share/nginx/html:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

volumes:
  frontend-dist:
